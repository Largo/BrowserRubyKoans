<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruby Koans Mountains are merely mountains</title>
    <link rel="stylesheet" href="assets/app.css">
    <script src="browser.script.iife.js"></script>
    <link rel="stylesheet" href="assets/codemirror.css">
    <script src="assets/codemirror.js"></script>
    <script src="assets/codemirror-ruby.js"></script>
</head>
<body>
    <h1>Ruby Koans</h1>
    <h2 id="encourageHeader">Mountains are merely mountains</h2>
    <textarea id="ruby-code" rows="10" cols="50"></textarea><br>
    <div class="buttons">
        <button id="run-code">Meditate</button>
    </div>
    
    <div id="output"></div>
  
  <script async>
    window.addEventListener('DOMContentLoaded', async function () {
        code_area = document.getElementById("ruby-code")
        window.editor = CodeMirror.fromTextArea(code_area, {
            lineNumbers: true,
            mode: "text/x-ruby",
            matchBrackets: true,
            indentUnit: 4
        });
        
        function clickRunButton() {
            window.editor.save()
            var output_div = document.getElementById("output");
            var code = `
                require 'js/require_remote'
                module Kernel
                    alias original_require_relative require_relative
                    def require_relative(path) = JS::RequireRemote.instance.load(path)
                end
                require_relative 'main.rb'
                pressButton {
                    ${code_area.value}
                }
            `.trim()
            const text = window.rubyVM.evalAsync(code).then((response) => {
                output_div.innerHTML = response.toString();
            }).catch((response) => {
                output_div.innerHTML = response.toString();
            });

        }
        var checkInterval = setInterval(() => window.rubyVM !== undefined && (clearInterval(checkInterval), clickRunButton()), 500);
        document.getElementById("run-code").addEventListener("click", async (e) => {
            clickRunButton();
        });
    });
  </script>

  <p>Ruby Koans is released under a Creative Commons, Attribution-NonCommercial-ShareAlike License. @jimweirich
  <br>In Memory of Jim Weirich (1956 - 2014)</p>
</body>
</html>
